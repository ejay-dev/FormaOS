'use server';

import { createSupabaseServerClient } from "@/lib/supabase/server";
import { revalidatePath } from "next/cache";

export async function getNotificationPreferences() {
  const supabase = await createSupabaseServerClient();
  const { data: { user } } = await supabase.auth.getUser();

  // Default fallback
  const defaults = {
    in_app_enabled: true,
    email_enabled: true,
    policy_updates: true,
    evidence_updates: true,
    task_updates: true,
    security_updates: true,
  };

  if (!user) return defaults;

  const { data } = await supabase
    .from('notification_preferences')
    .select('*')
    .eq('user_id', user.id)
    .single();

  if (!data) return defaults;

  return {
    in_app_enabled: data.in_app_enabled,
    email_enabled: data.email_enabled,
    policy_updates: data.policy_updates,
    evidence_updates: data.evidence_updates,
    task_updates: data.task_updates,
    security_updates: data.security_updates,
  };
}

export async function updateNotificationPreferences(prevState, formData) {
  const supabase = await createSupabaseServerClient();
  const { data: { user } } = await supabase.auth.getUser();

  if (!user) return { message: 'Unauthorized', success: false };

  const updates = {
    user_id: user.id,
    in_app_enabled: formData.get('in_app_enabled') === 'on',
    email_enabled: formData.get('email_enabled') === 'on',
    policy_updates: formData.get('policy_updates') === 'on',
    evidence_updates: formData.get('evidence_updates') === 'on',
    task_updates: formData.get('task_updates') === 'on',
    security_updates: formData.get('security_updates') === 'on',
    updated_at: new Date().toISOString(),
  };

  const { error } = await supabase
    .from('notification_preferences')
    .upsert(updates);

  if (error) {
    console.error('Error updating prefs:', error);
    return { message: 'Failed to save settings', success: false };
  }

  revalidatePath('/app/settings/notifications');
  
  return { message: 'Preferences saved successfully', success: true };
}