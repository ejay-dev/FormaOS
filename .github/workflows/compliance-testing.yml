name: Compliance Testing

on:
  schedule:
    - cron: '0 8 * * 1' # Weekly on Monday at 8 AM UTC
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of compliance test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - 'gdpr'
          - 'soc2'
          - 'iso27001'
  pull_request:
    branches: [main]
    paths:
      - 'app/**/privacy/**'
      - 'app/**/admin/**'
      - '**/middleware.ts'
      - 'tests/compliance/**'

jobs:
  gdpr-compliance:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'gdpr' || github.event_name != 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Start application
        run: |
          npm start &
          echo $! > app.pid
        env:
          NODE_ENV: production
          PORT: 3000

      - name: Wait for application
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: Create reports directory
        run: mkdir -p tests/compliance/reports

      - name: Run GDPR compliance tests
        id: gdpr_tests
        run: node tests/compliance/gdpr-compliance.js

      - name: Check GDPR compliance results
        id: check_gdpr
        run: |
          if [ -f tests/compliance/reports/gdpr-compliance-report.json ]; then
            FAILED_TESTS=$(node -e "const report = JSON.parse(require('fs').readFileSync('tests/compliance/reports/gdpr-compliance-report.json', 'utf8')); const allTests = Object.values(report.compliance).flat(); const failed = allTests.filter(test => !test.passed).length; console.log(failed);")
            VIOLATIONS=$(node -e "const report = JSON.parse(require('fs').readFileSync('tests/compliance/reports/gdpr-compliance-report.json', 'utf8')); console.log(report.violations.length);")
            
            echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
            echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
            
            if [ "$FAILED_TESTS" -gt "0" ] || [ "$VIOLATIONS" -gt "0" ]; then
              echo "status=failed" >> $GITHUB_OUTPUT
            else
              echo "status=passed" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=error" >> $GITHUB_OUTPUT
          fi

      - name: Stop application
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
            rm app.pid
          fi

      - name: Upload GDPR compliance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: gdpr-compliance-results
          path: |
            tests/compliance/reports/gdpr-compliance-report.json
          retention-days: 90

  soc2-compliance:
    runs-on: ubuntu-latest
    if: github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'soc2' || github.event_name != 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: Start application
        run: |
          npm start &
          echo $! > app.pid
        env:
          NODE_ENV: production
          PORT: 3000

      - name: Wait for application
        run: npx wait-on http://localhost:3000 --timeout 60000

      - name: Create reports directory
        run: mkdir -p tests/compliance/reports

      - name: Run SOC2 compliance tests
        id: soc2_tests
        run: node tests/compliance/soc2-compliance.js

      - name: Check SOC2 compliance results
        id: check_soc2
        run: |
          if [ -f tests/compliance/reports/soc2-compliance-report.json ]; then
            FAILED_CONTROLS=$(node -e "const report = JSON.parse(require('fs').readFileSync('tests/compliance/reports/soc2-compliance-report.json', 'utf8')); console.log(report.summary.failedControls);")
            VIOLATIONS=$(node -e "const report = JSON.parse(require('fs').readFileSync('tests/compliance/reports/soc2-compliance-report.json', 'utf8')); console.log(report.summary.violations);")
            
            echo "failed_controls=$FAILED_CONTROLS" >> $GITHUB_OUTPUT
            echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
            
            if [ "$FAILED_CONTROLS" -gt "0" ] || [ "$VIOLATIONS" -gt "0" ]; then
              echo "status=failed" >> $GITHUB_OUTPUT
            else
              echo "status=passed" >> $GITHUB_OUTPUT
            fi
          else
            echo "status=error" >> $GITHUB_OUTPUT
          fi

      - name: Stop application
        if: always()
        run: |
          if [ -f app.pid ]; then
            kill $(cat app.pid) || true
            rm app.pid
          fi

      - name: Upload SOC2 compliance results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: soc2-compliance-results
          path: |
            tests/compliance/reports/soc2-compliance-report.json
          retention-days: 90

  compliance-summary:
    runs-on: ubuntu-latest
    needs: [gdpr-compliance, soc2-compliance]
    if: always()

    steps:
      - name: Download all compliance results
        uses: actions/download-artifact@v4

      - name: Generate compliance summary
        run: |
          echo "## ðŸ”’ Compliance Testing Results" > summary.md
          echo "" >> summary.md
          echo "**Test Date:** $(date)" >> summary.md
          echo "**Test Type:** ${{ github.event.inputs.test_type || 'all' }}" >> summary.md
          echo "" >> summary.md

          # GDPR Results
          echo "### GDPR Compliance" >> summary.md
          if [ -f "gdpr-compliance-results/gdpr-compliance-report.json" ]; then
            GDPR_STATUS="${{ needs.gdpr-compliance.outputs.status || 'unknown' }}"
            if [ "$GDPR_STATUS" = "passed" ]; then
              echo "âœ… **PASSED** - All GDPR requirements met" >> summary.md
            elif [ "$GDPR_STATUS" = "failed" ]; then
              echo "âŒ **FAILED** - GDPR compliance issues found" >> summary.md
            else
              echo "âš ï¸ **ERROR** - Unable to complete GDPR testing" >> summary.md
            fi
          else
            echo "â­ï¸ **SKIPPED** - GDPR testing not requested" >> summary.md
          fi
          echo "" >> summary.md

          # SOC2 Results
          echo "### SOC2 Compliance" >> summary.md
          if [ -f "soc2-compliance-results/soc2-compliance-report.json" ]; then
            SOC2_STATUS="${{ needs.soc2-compliance.outputs.status || 'unknown' }}"
            if [ "$SOC2_STATUS" = "passed" ]; then
              echo "âœ… **PASSED** - All SOC2 controls implemented" >> summary.md
            elif [ "$SOC2_STATUS" = "failed" ]; then
              echo "âŒ **FAILED** - SOC2 control deficiencies found" >> summary.md
            else
              echo "âš ï¸ **ERROR** - Unable to complete SOC2 testing" >> summary.md
            fi
          else
            echo "â­ï¸ **SKIPPED** - SOC2 testing not requested" >> summary.md
          fi
          echo "" >> summary.md

          echo "**Compliance Reports:** Available in the artifacts section below" >> summary.md
          echo "" >> summary.md

          # Overall status
          if [[ "${{ needs.gdpr-compliance.result }}" == "failure" || "${{ needs.soc2-compliance.result }}" == "failure" ]]; then
            echo "**âš ï¸ ATTENTION REQUIRED:** Compliance issues found that must be addressed before production deployment." >> summary.md
          elif [[ "${{ needs.gdpr-compliance.result }}" == "success" && "${{ needs.soc2-compliance.result }}" == "success" ]]; then
            echo "**âœ… COMPLIANCE READY:** All tested compliance requirements met." >> summary.md
          fi

          cat summary.md

      - name: Upload compliance summary
        uses: actions/upload-artifact@v4
        with:
          name: compliance-test-summary
          path: summary.md
          retention-days: 90

      - name: Comment PR with compliance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            if (fs.existsSync('summary.md')) {
              const summary = fs.readFileSync('summary.md', 'utf8');
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }
